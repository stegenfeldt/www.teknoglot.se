<!DOCTYPE html>
<html>
<head>
    <!-- hexo-inject:begin --><script src='https://unpkg.com/echarts@3.3.2/dist/echarts.min.js'></script><!-- hexo-inject:end --><meta charset="utf-8">
    
    <title>Tag: PoSH | teknoglot:</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="description" content="Techspeak for the socially diminished.">
<meta property="og:type" content="website">
<meta property="og:title" content="teknoglot:">
<meta property="og:url" content="https:&#x2F;&#x2F;www.teknoglot.se&#x2F;tag&#x2F;PoSH&#x2F;index.html">
<meta property="og:site_name" content="teknoglot:">
<meta property="og:description" content="Techspeak for the socially diminished.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
    

    

    
        <link rel="icon" href="/favicon.png" />
    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/titillium-web/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
    
        <script type="text/javascript">
(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-382656-8', 'auto');
ga('send', 'pageview');

</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
    

</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                        <li class="main-nav-list-item">
                                            <a class="main-nav-list-link" href="/">
                                                Home
                                            </a>
                                        </li>
                                        
                                <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/code/">Code</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/code/posh/">PoSH</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/code/vbs/">VBS</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/Events/">Events</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/Events/MSIgnite-2017/">MSIgnite 2017</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/Fieldnotes/">Fieldnotes</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/Fieldnotes/OpsMgr/">OpsMgr</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/linux/">Linux</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/linux/rhes/">RedHat ES</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/linux/sles/">SLES</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/linux/ubuntu/">Ubuntu</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/">Microsoft</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/opsmgr1801/">OpsMgr 1801</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/opsmgr1807/">OpsMgr 1807</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/opsmgr2007/">OpsMgr 2007</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/opsmgr2012/">OpsMgr 2012</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/opsmgr2016/">OpsMgr 2016</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/sql/">SQL Server</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/windows/">Windows</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/ms/winvista/">Windows Vista</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/mikrotik/">Mikrotik</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/topics/tb/">Technobabble</a></li></ul>
                                    
                                        <li class="main-nav-list-item">
                                            <a class="main-nav-list-link" href="/About/">
                                                About
                                            </a>
                                        </li>
                                        
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <i class="icon fa fa-tag"></i>Tag: <em>PoSH</em>
    </h1>
</div>
                        <div class="main-body-content">
                            

    
    
        
        
        <section class="archives-wrap">
            <div class="archive-year-wrap">
                <a href="/archives/2014" class="archive-year"><i class="icon fa fa-calendar-o"></i>2014</a>
            </div>
            <div class="archives">
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/mikrotik/">Mikrotik</a>
            </p>
            <p class="date"><time datetime="2014-08-25T11:37:36.000Z" itemprop="datePublished">2014-08-25</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/mikrotik/cloudflare-dynamic-dns-mikrotik/">Cloudflare as Dynamic DNS [#cloudflare #mikrotik #script]</a>
        </h1>
    

        <p class="article-excerpt">
             Background
I have, for a time, been using CloudFlare for CDN, Optimizations and DNS Management for this and a few other domains. At the same time, I‚Äôve been using DynDNS to provide name resolution to my home network/lab. Browsing around the CloudFlare JSON¬†API I noticed that I can update DNS records through¬†some fairly simple HTTP GET requests, and since the RouterOS (the operating system used by Mikrotik‚Äôs routerboards) has support for some pretty decent scripting I decided to let my router update CloudFlare for some custom and free dynamic DNS resolution.
 Attribution
My current script is a modified version of a¬†script developed¬†by¬†Konstantin Antselovich.
Original script:¬†http://konstant1n.livejournal.com/9759.html
Original Author website:¬†http://konstantin.antselovich.com/
Thanks!
 How you do it
 What you need

RouterOS v6+ for HTTPS support
Cloudflare API key, aka ‚ÄúToken‚Äù, found at the account page
Cloudflare DNS Zone name
Cloudflare Record Id (more on that later)
Cloudflare subdomain name
Name of the external router interface

        </p>
    </div>
</article>
    

    
    
        
            </div></section>
        
        
        <section class="archives-wrap">
            <div class="archive-year-wrap">
                <a href="/archives/2012" class="archive-year"><i class="icon fa fa-calendar-o"></i>2012</a>
            </div>
            <div class="archives">
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2012/">OpsMgr 2012</a>
            </p>
            <p class="date"><time datetime="2012-06-28T12:28:36.000Z" itemprop="datePublished">2012-06-28</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2012/opsmgr-2012-agent-failover-a-faster-script-with-wildcards-opsmgr-powershell/">OpsMgr 2012 Agent Failover ‚Äì A Faster Script with Wildcards [#opsmgr, #powershell]</a>
        </h1>
    

        <p class="article-excerpt">
            Now we‚Äôre gonna make things even faster! In the previous post on the subject of Agent¬†Fail-over¬†in Operations Manager 2012 we created a script that will go through a selection of agents and make sure that they all have up-to-date¬†fail-over¬†settings. We are doing the same thing in this one, but making it go faster. In my lab, it‚Äôs about five times faster in fact and I only have about 20 agents to play with. Not really a big deal, but scale it up a bit and add a few thousand agents and the pay-off will be very significant.
As usual, the script will work as is, but it really is more to show the concept. You would have to add filtering to make sure you don‚Äôt mix agents behind gateway servers and agents behind management servers. Giving an agent behind a gateway a management servers as it‚Äôs fail-over server will likely not help you in any way.
We will pretty quickly go ‚Äúadvanced‚Äù this time, so buckle up. üòâ

Being a slight modification of the script in the last post I am not going to go through those details. Use that post if you need references to the Inputs, the OpsMgr 2012 Modules, Management Group connection and gathering your agents and management servers.
 Why Is It Faster?
We are doing the same thing, on the same agents and with the same servers. And we already did some optimization by loading them all into memory and working from there. How do you make it faster? Basically, I‚Äôm cutting the over-head of the cmdlets and how they work. You may have noticed that in the ‚ÄúDo Stuff‚Äù section, we are actually calling the Set-SCOMParentManagementServer cmdlet twice! Once for the primary Management Server and once for the fail-over Management Servers. In effect, we connect, fire a command, wait for result, and disconnect two times for each agent. And pretty much only because the cmdlet does not offer support to set primary and fail-over management servers at the same time. Any attempt to do so will return an ambiguous¬†parameter error.
I don‚Äôt like that. A brief look at the agent object class,¬†Microsoft.EnterpriseManagement.Administration.AgentManagedComputer, revealed a method called¬†SetManagementServers. This method takes, or actually ‚Äúrequires‚Äù, two parameters. One for primary and one for fail-over management servers. Yay!
Using this method saves us a bunch of over-head and a couple of round-trips to the SDK-service.
 The Challenge
        </p>
    </div>
</article>
    

    
    
    
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2012/">OpsMgr 2012</a>
            </p>
            <p class="date"><time datetime="2012-06-21T08:58:13.000Z" itemprop="datePublished">2012-06-21</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2012/opsmgr-2012-agent-failover-simple-script-with-wildcards-opsmgr-powershell/">OpsMgr 2012 Agent Failover - Simple Script with Wildcards [#opsmgr, #powershell]</a>
        </h1>
    

        <p class="article-excerpt">
            In the last post,¬†OpsMgr 2012 Agent &amp; Gateway Failover ‚Äì The Basics, we looked at the basics of the Agent and Gateway¬†fail-over¬†configuration cmdlets and how to use them in a direct and interactive setting. This is absolutely useful when you got this specific agent that you need to configure with a specific¬†fail-over¬†management server.
To spice it up a little, we are going to add a little intelligence to it and enable wild-card selections while at it. The scenario we are building this script for is that now and then you want to make sure that certain agents have fail-over management servers configured. You also want to make sure that all management servers that are not the primary management server of any selected agent will be in that list of fail-over servers. This would include any new¬†management¬†servers as well as exclude any removed ones. In short, make sure your agent fail-over settings are up-to-date with the current environment.

 Inputs
To use this script you need to know which management server you should connect your powershell session to and which agent, or agents, you want to check and configure.
# Input SCOM Management Server to connect to in this session[string]$inputScomMS = "scomms01.domain.local"# Input an existing agent you want to modify[string]$inputTargetAgent = "*.domain.local"

Note: If you are using load-balanced SDK-services, or ‚ÄúData Access Services‚Äù, pointing $inputScomMS to that virtual host-name will work perfectly fine.
This example uses a wild-card for the agent selection and I guess it‚Äôs the most likely scenario for this script, but a single host-name obviously works fine as well. Supported wildcard selections are documented at TechNet. An array of computer-names or a comma-separated list, however, will not work. You could easily add that functionality but it‚Äôs out of scope for this example.

 Connect to Your Management Group
To run any script against an Operations Manager 2012 Management Group we need a connection to one. To connect to a management group we have to load the OperationsManager module. Lets check for a loaded module, load it if necessary and connect to the Management Server from the $inputScomMS setting. If loading the module fails‚Äìmaybe it is not installed‚Äìwe will exit the script.
# Check if OperationsManager module is loadedIf (Get-Module -Name "OperationsManager") &#123;    try &#123;        # Try to load the module        Import-Module -Name "OperationsManager"    &#125; catch &#123;        # Did not work, exit the script        Write-Output "Could not load Operations Manager module"        exit    &#125;&#125;# Module is loaded, connect to Management Group/ServerNew-SCOMManagementGroupConnection -ComputerName $inputScomMS
        </p>
    </div>
</article>
    
        </div>
    

    
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2012/">OpsMgr 2012</a>
            </p>
            <p class="date"><time datetime="2012-05-30T12:12:37.000Z" itemprop="datePublished">2012-05-30</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2012/opsmgr-2012-agent-gateway-failover-the-basics/">OpsMgr 2012 Agent &amp; Gateway Failover - The Basics [#opsmgr, #powershell]</a>
        </h1>
    

        <p class="article-excerpt">
            I have previously posted a few scripts on managing and configuring fail-over management servers on gateways and agents in System Center Operations Manager 2007 R2.
Now that System Center 2012 Operations Manager is RTM and users are starting to explore the differences between the versions I see more and more questions on how you do, in OpsMgr 2012, what you did in OpsMgr 2007. In a few posts henceforth I will go through Agent and Gateway server fail-over configuration and management. In this first post I‚Äôll look at the very basics of fail-over configuration, the cmdlets to use and some one-liners.

 The cmdlet
First of all, the cmdlets of OpsMgr powershell have all got new names looking like Verb-SCOM_noun_ and to list them all in the console you can execute the following command:
get-command *SCOM*
The cmdlet we are looking for to set and manage primary and fail-over management servers is
Get-SCOMParentManagementServer
As usual, you can pass the cmdlet as a parameter to get-help for information about its parameters and a few use-cases.

SYNOPSIS
Changes the primary and failover management servers for an agent or gateway management server.
SYNTAX
Set-SCOMParentManagementServer -Agent -PrimaryServer [-PassThru ] [-Confirm ] [-WhatIf ] []
Set-SCOMParentManagementServer -Agent -FailoverServer [-PassThru ] [-Confirm ] [-WhatIf ] []
Set-SCOMParentManagementServer -GatewayServer -FailoverServer [-PassThru ] [-Confirm ] [-WhatIf ] []
Set-SCOMParentManagementServer -GatewayServer -PrimaryServer [-PassThru] [-Confirm] [-WhatIf] []
But that‚Äôs so boring to read the manual is a bit sketchy on how it behaves and the limitations.

        </p>
    </div>
</article>
    

    
    
    
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/code/">Code</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/code/posh/">PoSH</a>
            </p>
            <p class="date"><time datetime="2012-05-15T13:14:00.000Z" itemprop="datePublished">2012-05-15</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/code/posh/quick-hack-send-sms-through-powershell-powershell/">Quick-Hack: Send SMS through Powershell [#powershell]</a>
        </h1>
    

        <p class="article-excerpt">
            Decided to do a quick-hack/fast-publish on this one as I have had a bit less time to create a nice clean production-ready version as of yet‚Ä¶ and people has been asking about how far off the article is.
What this script does is to send a text message using a GSM/GPRS modem connected to a local (or LAN-connected with local drivers) serial port using Powershell.
 Disclaimer!
This script ‚Äúworks‚Äù but is not fit for production. See it as an example of the general concept to evolve and adapt into something worthy of production use.
What‚Äôs missing in the latest iteration is:

A working Event-Handler to deal with¬†asynchronous call-backs.
Support for AT+MSGW (write to modem memory)
Reusing messages in modem memory for multiple recipients.
Various error- and exeption-handlers.
Actually verifying that the modem is AT-capable.
Querying the system for available modems and their ports.

 The Script
So, a short note before digging into the script. Prerequisites for this script is that you have identified which COM-port to use and it‚Äôs supported baud-rates and¬†whether¬†it supports DTR or not. If you do not know what the hell¬†I am talking about, you could probably have it work with my preconfigured settings anyway. If you are unsure about if your modem supports AT commands you could open a serial connection to the modem using Hyperterminal or PuTTY and run AT+CMGF=1. If supported, the return should be OK. If it is not supported (you get ERROR instead) you would have to use PDU-mode which require a bit of hex-encoding of your messages. This is nothing I have had to do yet and will not be including in this script. Maybe in the future. Maybe.
So, looking a some powershelling then. First thing would be to connect to the modem.
# Create your instance of the SerialPort Class$serialPort = new-Object System.IO.Ports.SerialPort# Set various COM-port settings$serialPort.PortName = "COM1"$serialPort.BaudRate = 19200$serialPort.WriteTimeout = 500$serialPort.ReadTimeout = 3000$serialPort.DtrEnable = "true"# Open the connection$serialPort.Open()
        </p>
    </div>
</article>
    
        </div>
    

    
    
        
            </div></section>
        
        
        <section class="archives-wrap">
            <div class="archive-year-wrap">
                <a href="/archives/2011" class="archive-year"><i class="icon fa fa-calendar-o"></i>2011</a>
            </div>
            <div class="archives">
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2007/">OpsMgr 2007</a>
            </p>
            <p class="date"><time datetime="2011-07-07T08:59:24.000Z" itemprop="datePublished">2011-07-07</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2007/bulk-disable-acs-forwarders-with-wildcards/">Bulk disable ACS Forwarders (with wildcards)</a>
        </h1>
    

        <p class="article-excerpt">
            Here‚Äôs a little something-something for the wicked.
Me and my apprentice is currently decommissioning an entire Management Group with a thousand (-ish) agents. Long story short, we got a new Management Group, migrated all the agents, added a couple of hundreds more, deployed a bunch of gateways and now we are shutting down the old one.
Now, uninstalling the old Management Group from all the agents is a breeze using SCCM and handling the few 20-ish servers that are left is not a biggie either. Shutting down ACS, however, is a different matter.

Although you do configure your forwarders using Operations Manager, removing the management group you were running ACS in does not mean the agents will shut down and disable the AdtAgent service or stop trying to forward audit events to your collector. Now, selecting 10 agents at the time and running the ‚ÄúDisable Audit Collection‚Äù task‚Äìin case you did not know, there‚Äôs a limitation on how many agents you can run a task on in the Operations Console‚Äìis not my idea of a jolly good day and since Powershell is a bucket of joy in comparison; here‚Äôs a script for you all!
DisableACSForwarders
It is zipped to avoid security alerts, but as with any script found on the internet I implore to to read the code before actually running it.
Anyway, you can use it in a couple of ways.
To run it interactively, just go to the directory where you unpacked it and run it. You will be requested to enter the FQDN of you Root Management Server and a wildcard search for ACS Forwarders.
For example:
C:\..\Scripts&gt; .\DisableACSForwarders.ps1Root Management Server: rms.teknoglot.localACS Forwarder name (wildcard): *.teknoglot.local
        </p>
    </div>
</article>
    

    
    
        
            </div></section>
        
        
        <section class="archives-wrap">
            <div class="archive-year-wrap">
                <a href="/archives/2010" class="archive-year"><i class="icon fa fa-calendar-o"></i>2010</a>
            </div>
            <div class="archives">
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2007/">OpsMgr 2007</a>
            </p>
            <p class="date"><time datetime="2010-03-31T13:27:08.000Z" itemprop="datePublished">2010-03-31</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2007/change-gateway-powershell-script/">Change Gateway Powershell Script</a>
        </h1>
    

        <p class="article-excerpt">
            This script has pretty much already been covered in my previous post about Changing or Replacing an Operations Manager Gateway Server.
This time I‚Äôve basically put parameter support in it to make it easier to use.
Here‚Äôs the script anyway.
Param($OldGW,$NewGW)$OldMS= Get-ManagementServer | where &#123;$_.Name -eq $OldGW&#125;$NewMS = Get-ManagementServer | where &#123;$_.Name -eq $NewGW&#125;$agents = Get-Agent | where &#123;$_.PrimaryManagementServerName -eq $OldGW&#125;$agents = $agents"Moving " + $agents.count + " agents from " + $OldMS.Name + " to " + $NewMS.NameStart-Sleep -m 200Set-ManagementServer -AgentManagedComputer: $agents -PrimaryManagementServer: $NewMS -FailoverServer: $OldMS
To use it, create a textfile called ChangeGW.ps1 and paste the code into it. Save the file somewhere neat (maybe C:Scripts) for easy access. If you don‚Äôt feel like copy/pasting, you can download the script here.
To use it, open the Operations Manager Command Shell and type:
C:\ScriptsChangeGW.ps1 &lt;old.gatewayserver.dns.name&gt; &lt;new.gatewayserver.dns.name&gt;
For example:
C:\ScriptsChangeGW.ps1 gwserver01.domainname.local gwserver02.domainname.local
        </p>
    </div>
</article>
    

    
    
        
            </div></section>
        
        
        <section class="archives-wrap">
            <div class="archive-year-wrap">
                <a href="/archives/2009" class="archive-year"><i class="icon fa fa-calendar-o"></i>2009</a>
            </div>
            <div class="archives">
    
    
    
        <div class="article-row">
    
        <article class="article article-summary">
    <div class="article-summary-inner">
        
        <div class="article-meta">
            <p class="category">
            <a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2007/">OpsMgr 2007</a>
            </p>
            <p class="date"><time datetime="2009-09-24T10:32:35.000Z" itemprop="datePublished">2009-09-24</time></p>
        </div>
        
    
        <h1 class="article-title" itemprop="name">
        <a href="/ms/opsmgr2007/replacechange-a-gateway-server/">Replace/Change a Gateway Server</a>
        </h1>
    

        <p class="article-excerpt">
             Description of problem
If you are looking into replacing an (or just switching to another primary) Operations Manager 2007 Gateway Server for any reason, there‚Äôs a little more to consider than just right-clicking the clients and selecting ‚ÄúChange Primary Management Server‚Äù in the Operations Console.
You could end up with agents not being able to connect to the Management Group at all due to a small problem with the order in which Operations Manager do things.
Here‚Äôs basically what happens:

You tell Operations Manager to change Primary Management Server for AGENTX from GW1 to GW2.
The SDK Service (i guess) tells GW1 that ‚ÄúYou‚Äôre no longer the Primary Management Server for AGENTX‚Äù
GW1 acknowledges this and stops talking to AGENTX.  And I mean Completely stops talking to AGENTX.
OpsMgr then tells GW2 to start accepting communication from AGENTX.
OpsMgr tries to tell AGENTX that it should talk to GW2 since GW1 won‚Äôt listen.

Spotted the problem?
This modus operandi probably works when agents are on the same network and in the same domain where fail-over is sort of automatic.  The problem we are facing now is that the server are telling the Gateway to stop accepting communications to and from the agent before the agent is notified that there is a new Gateway server to talk to. The agent will continue to talk to GW1 but will be completely ignored and you will probably start seeing events in the Operations Manager eventlog on GW1 with EventID 20000.
How do I get around this little feature then?
No matter if you found this article after running into the mentioned troubles or if you are googling ahead of time to be prepared, the fix is the same and consists of a few powershell scripts. These scripts are out there allready, but in different contexts, hence this post.
 First step:  Install the new Gateway
Documentation on this from Microsoft is good enough, but here‚Äôs the short version.

Verify name resolution to and from Gateway server and Management Server
Create certificate for the Gateway server
Approve the Gateway server
Install Gateway server
Import certificates on Windows system
Run MOMCertImport.exe on Gateway server to add the certificate into Gateway server configuration
Wait

        </p>
    </div>
</article>
    


    </div></section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com/teknoglot" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="https://plus.google.com/+teknoglotse" target="_blank">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="bitbucket" href="https://bitbucket.org/stegenfeldt" target="_blank">
                        <i class="icon fa fa-bitbucket"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/stegenfeldt" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/rss.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/topics/Fieldnotes/">Fieldnotes</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/Fieldnotes/OpsMgr/">OpsMgr</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr1801/">OpsMgr 1801</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr1807/">OpsMgr 1807</a></p>
                            <p class="item-title"><a href="/ms/opsmgr1801/Upgrading-OpsMgr-1801-to-1807-Fieldnotes/" class="title">Upgrading #OpsMgr 1801 to 1807 - Fieldnotes</a></p>
                            <p class="item-date"><time datetime="2018-09-06T12:42:51.000Z" itemprop="datePublished">2018-09-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/topics/ms/">Microsoft</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/ms/opsmgr2016/">OpsMgr 2016</a></p>
                            <p class="item-title"><a href="/ms/opsmgr2016/om1801-upgrade-gotchas/" class="title">#OpsMgr 1801 Upgrade - The Fail Anthology</a></p>
                            <p class="item-date"><time datetime="2018-08-27T13:42:17.000Z" itemprop="datePublished">2018-08-27</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/topics/Events/">Events</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/Events/MSIgnite-2017/">MSIgnite 2017</a></p>
                            <p class="item-title"><a href="/Events/MSIgnite-2017/MSIgnite-2017-BRK1039-Windows-Server-Software-Defined/" class="title">#MSIgnite 2017: BRK1039 - Windows Server Software Defined</a></p>
                            <p class="item-date"><time datetime="2017-09-26T08:23:13.000Z" itemprop="datePublished">2017-09-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/topics/Events/">Events</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/Events/MSIgnite-2017/">MSIgnite 2017</a></p>
                            <p class="item-title"><a href="/Events/MSIgnite-2017/MSIgnite-2017-GS01-Microsoft-for-the-Modern-Data-Estate/" class="title">#MSIgnite 2017: GS01 - Microsoft for the Modern Data Estate</a></p>
                            <p class="item-date"><time datetime="2017-09-25T13:34:36.000Z" itemprop="datePublished">2017-09-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/topics/Events/">Events</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/topics/Events/MSIgnite-2017/">MSIgnite 2017</a></p>
                            <p class="item-title"><a href="/Events/MSIgnite-2017/MSIgnite-2017-TK01-Create-a-Modern-Workplace-with-Microsoft-365/" class="title">#MSIgnite 2017: TK01 - Create a Modern Workplace with Microsoft 365</a></p>
                            <p class="item-date"><time datetime="2017-09-25T10:17:15.000Z" itemprop="datePublished">2017-09-25</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/topics/code/">Code</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/code/posh/">PoSH</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/code/vbs/">VBS</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/Events/">Events</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/Events/MSIgnite-2017/">MSIgnite 2017</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/Fieldnotes/">Fieldnotes</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/Fieldnotes/OpsMgr/">OpsMgr</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/linux/">Linux</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/linux/rhes/">RedHat ES</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/linux/sles/">SLES</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/linux/ubuntu/">Ubuntu</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/">Microsoft</a><span class="category-list-count">41</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/ms/opsmgr1801/">OpsMgr 1801</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/opsmgr1807/">OpsMgr 1807</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/opsmgr2007/">OpsMgr 2007</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/opsmgr2012/">OpsMgr 2012</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/opsmgr2016/">OpsMgr 2016</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/sql/">SQL Server</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/windows/">Windows</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/topics/ms/windows/winxp/">Windows XP</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/ms/winvista/">Windows Vista</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/topics/mikrotik/">Mikrotik</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/topics/tb/">Technobabble</a><span class="category-list-count">9</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tag/ACS/" style="font-size: 10px;">ACS</a> <a href="/tag/Advanced-Threat-Protection/" style="font-size: 10px;">Advanced Threat Protection</a> <a href="/tag/Checklist/" style="font-size: 10px;">Checklist</a> <a href="/tag/Conference/" style="font-size: 10px;">Conference</a> <a href="/tag/DNS/" style="font-size: 10px;">DNS</a> <a href="/tag/Drivers/" style="font-size: 12.5px;">Drivers</a> <a href="/tag/Errors/" style="font-size: 15px;">Errors</a> <a href="/tag/Exchange/" style="font-size: 10px;">Exchange</a> <a href="/tag/Fail-over/" style="font-size: 12.5px;">Fail-over</a> <a href="/tag/Field-Notes/" style="font-size: 12.5px;">Field Notes</a> <a href="/tag/Fieldnotes/" style="font-size: 10px;">Fieldnotes</a> <a href="/tag/Fixed/" style="font-size: 10px;">Fixed</a> <a href="/tag/GSM/" style="font-size: 10px;">GSM</a> <a href="/tag/Gist/" style="font-size: 10px;">Gist</a> <a href="/tag/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tag/Highly-Available/" style="font-size: 10px;">Highly-Available</a> <a href="/tag/How-To/" style="font-size: 17.5px;">How-To</a> <a href="/tag/HowTo/" style="font-size: 10px;">HowTo</a> <a href="/tag/Hyper-Converged/" style="font-size: 10px;">Hyper-Converged</a> <a href="/tag/Hyper-V/" style="font-size: 10px;">Hyper-V</a> <a href="/tag/IIS7/" style="font-size: 10px;">IIS7</a> <a href="/tag/Invoke-RestMethod/" style="font-size: 10px;">Invoke-RestMethod</a> <a href="/tag/Issues/" style="font-size: 10px;">Issues</a> <a href="/tag/KB/" style="font-size: 11.25px;">KB</a> <a href="/tag/Linux/" style="font-size: 13.75px;">Linux</a> <a href="/tag/MP-Development/" style="font-size: 12.5px;">MP Development</a> <a href="/tag/MSIgnite/" style="font-size: 13.75px;">MSIgnite</a> <a href="/tag/MSMQ/" style="font-size: 13.75px;">MSMQ</a> <a href="/tag/Machine-Learning/" style="font-size: 10px;">Machine Learning</a> <a href="/tag/Macro/" style="font-size: 10px;">Macro</a> <a href="/tag/Management-Pack/" style="font-size: 18.75px;">Management Pack</a> <a href="/tag/Microsoft-265/" style="font-size: 10px;">Microsoft 265</a> <a href="/tag/Microsoft-Teams/" style="font-size: 10px;">Microsoft Teams</a> <a href="/tag/Mikrotik/" style="font-size: 10px;">Mikrotik</a> <a href="/tag/NLB/" style="font-size: 10px;">NLB</a> <a href="/tag/NVidia/" style="font-size: 10px;">NVidia</a> <a href="/tag/Office/" style="font-size: 10px;">Office</a> <a href="/tag/Office-365/" style="font-size: 10px;">Office 365</a> <a href="/tag/OneDrive/" style="font-size: 10px;">OneDrive</a> <a href="/tag/OpenVPN/" style="font-size: 10px;">OpenVPN</a> <a href="/tag/OpsMgr/" style="font-size: 20px;">OpsMgr</a> <a href="/tag/OpsMgr-1801/" style="font-size: 10px;">OpsMgr 1801</a> <a href="/tag/OpsMgr-2007/" style="font-size: 10px;">OpsMgr 2007</a> <a href="/tag/OpsMgr-2012-R2/" style="font-size: 11.25px;">OpsMgr 2012 R2</a> <a href="/tag/OpsMgr-2016/" style="font-size: 10px;">OpsMgr 2016</a> <a href="/tag/PoSH/" style="font-size: 16.25px;">PoSH</a> <a href="/tag/Powershell/" style="font-size: 11.25px;">Powershell</a> <a href="/tag/Presentation-Notes/" style="font-size: 13.75px;">Presentation Notes</a> <a href="/tag/Quick-Reference/" style="font-size: 10px;">Quick Reference</a> <a href="/tag/Quick-fix/" style="font-size: 10px;">Quick-fix</a> <a href="/tag/Quick-hack/" style="font-size: 10px;">Quick-hack</a> <a href="/tag/RHES5/" style="font-size: 10px;">RHES5</a> <a href="/tag/Rant/" style="font-size: 13.75px;">Rant</a> <a href="/tag/RedHat/" style="font-size: 10px;">RedHat</a> <a href="/tag/Reporting-Services/" style="font-size: 10px;">Reporting Services</a> <a href="/tag/RouterOS/" style="font-size: 10px;">RouterOS</a> <a href="/tag/SMS/" style="font-size: 10px;">SMS</a> <a href="/tag/SQL-2017/" style="font-size: 10px;">SQL 2017</a> <a href="/tag/SQL-Express-2005/" style="font-size: 10px;">SQL Express 2005</a> <a href="/tag/SQL-Express-2008/" style="font-size: 10px;">SQL Express 2008</a> <a href="/tag/SQL-Server/" style="font-size: 11.25px;">SQL Server</a> <a href="/tag/SQL-Server-2005/" style="font-size: 10px;">SQL Server 2005</a> <a href="/tag/SQL-Server-2008/" style="font-size: 10px;">SQL Server 2008</a> <a href="/tag/SQL-on-Linux/" style="font-size: 10px;">SQL on Linux</a> <a href="/tag/SUSE-11/" style="font-size: 10px;">SUSE 11</a> <a href="/tag/Script/" style="font-size: 16.25px;">Script</a> <a href="/tag/Scripts/" style="font-size: 10px;">Scripts</a> <a href="/tag/SharePoint/" style="font-size: 10px;">SharePoint</a> <a href="/tag/Sillyness/" style="font-size: 10px;">Sillyness</a> <a href="/tag/SquaredUp/" style="font-size: 10px;">SquaredUp</a> <a href="/tag/Teach-a-Man-to-Fish/" style="font-size: 10px;">Teach a Man to Fish</a> <a href="/tag/TechNet/" style="font-size: 10px;">TechNet</a> <a href="/tag/Technical-Keynote/" style="font-size: 10px;">Technical Keynote</a> <a href="/tag/Teknoglot/" style="font-size: 12.5px;">Teknoglot</a> <a href="/tag/TroubleShooting/" style="font-size: 11.25px;">TroubleShooting</a> <a href="/tag/Tutorial/" style="font-size: 10px;">Tutorial</a> <a href="/tag/Unix/" style="font-size: 10px;">Unix</a> <a href="/tag/Update-Rollup/" style="font-size: 11.25px;">Update Rollup</a> <a href="/tag/Upgrade/" style="font-size: 10px;">Upgrade</a> <a href="/tag/VBScript/" style="font-size: 10px;">VBScript</a> <a href="/tag/Video/" style="font-size: 10px;">Video</a> <a href="/tag/Virtual-Appliance/" style="font-size: 10px;">Virtual Appliance</a> <a href="/tag/WMI/" style="font-size: 10px;">WMI</a> <a href="/tag/WSSD/" style="font-size: 10px;">WSSD</a> <a href="/tag/Windows/" style="font-size: 12.5px;">Windows</a> <a href="/tag/Windows-2008/" style="font-size: 10px;">Windows 2008</a> <a href="/tag/Windows-Installer/" style="font-size: 10px;">Windows Installer</a> <a href="/tag/Windows-Vista/" style="font-size: 10px;">Windows Vista</a> <a href="/tag/Windows-XP/" style="font-size: 10px;">Windows XP</a> <a href="/tag/Word/" style="font-size: 10px;">Word</a> <a href="/tag/Wordpress/" style="font-size: 10px;">Wordpress</a> <a href="/tag/X-Plat/" style="font-size: 11.25px;">X-Plat</a> <a href="/tag/Yammer/" style="font-size: 10px;">Yammer</a> <a href="/tag/x64/" style="font-size: 11.25px;">x64</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://www.atea.se/" target="_blank" rel="noopener">Atea</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;" target="_blank" rel="noopener"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2019 Samuel Tegenfeldt</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'teknoglotse';
    
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    

    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
